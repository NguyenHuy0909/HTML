Option Explicit

Sub Import_BySpaces_UseCHANNEL_Robust()
    Dim p$, f%, s$, header$, ws As Worksheet
    Dim rxDelim As Object, foundHdr As Boolean
    Dim r&, c&, parts, t, i&, startPos&, endPos&
    
    ' Chọn file
    p = Application.GetOpenFilename("Text files,*.txt;*.log,*.*,*.*")
    If p = "False" Then Exit Sub

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    Set ws = GetOrCreate("Data"): ws.Cells.Clear
    
    ' Delimiter: Tab HOẶC cụm ≥3 space
    Set rxDelim = CreateObject("VBScript.RegExp")
    rxDelim.Global = True
    rxDelim.Pattern = "(?:\t| {3,})+"   ' nhận cả tab lẫn ≥3 space

    ' ---------- 1) TÌM VÀ GHÉP BLOCK CHANNEL=[...] ----------
    f = FreeFile: Open p For Input As #f
    Do Until EOF(f)
        Line Input #f, s
        If InStr(1, s, "CHANNEL", vbTextCompare) > 0 And InStr(1, s, "=", vbTextCompare) > 0 Then
            header = s
            Do While InStr(1, header, "]") = 0 And Not EOF(f)
                Line Input #f, s
                header = header & " " & s
            Loop
            foundHdr = (InStr(1, header, "]") > 0)
            Exit Do
        End If
    Loop
    
    ' Nếu có header → bóc tên cột và ghi hàng 1
    If foundHdr Then
        startPos = InStr(header, "["): endPos = InStrRev(header, "]")
        If startPos > 0 And endPos > startPos Then
            header = Mid$(header, startPos + 1, endPos - startPos - 1)
            header = Replace(header, "&", "")
            header = Replace(header, "'", "")
            header = Replace(header, vbTab, "")
            header = Replace(header, vbCr, "")
            header = Replace(header, vbLf, "")
            parts = Split(header, ",")
            For i = LBound(parts) To UBound(parts)
                If Len(Trim$(parts(i))) > 0 Then ws.Cells(1, i + 1).Value = Trim$(parts(i))
            Next
        End If
    End If
    
    ' ---------- 2) ĐỌC DATA ----------
    ' Nếu KHÔNG tìm thấy CHANNEL, báo và đọc toàn file từ đầu làm data
    If Not foundHdr Then
        MsgBox "Không tìm thấy CHANNEL= trong file. Sẽ import toàn bộ như data.", vbExclamation
        Close #f
        f = FreeFile: Open p For Input As #f
    End If
    
    r = IIf(foundHdr, 2, 1)
    Do Until EOF(f)
        Line Input #f, s
        If Len(Trim$(s)) = 0 Then GoTo NextLine
        ' Chuyển delimiter về Tab rồi tách cột
        s = rxDelim.Replace(s, vbTab)
        parts = Split(s, vbTab)
        c = 0
        For Each t In parts
            t = Trim$(t)
            If Len(t) > 0 Then
                ' Nếu bạn muốn loại mọi khoảng trắng trong token, dùng dòng dưới:
                ' t = Replace(t, " ", "")
                c = c + 1
                ws.Cells(r, c).Value = t
            End If
        Next
        If c > 0 Then r = r + 1
NextLine:
    Loop
    Close #f

    ws.UsedRange.Columns.AutoFit

CleanExit:
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub

Private Function GetOrCreate(name$) As Worksheet
    On Error Resume Next: Set GetOrCreate = ThisWorkbook.Sheets(name)
    If GetOrCreate Is Nothing Then
        Set GetOrCreate = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        GetOrCreate.Name = name
    End If
End Function
