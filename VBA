Option Explicit

Sub Import_BySpaces_UsingCHANNEL()
    Dim p$, f%, s$, header$, ws As Worksheet, rxSplit As Object
    Dim i&, r&, c&, parts, t, startPos&, endPos&, hdrItems() As String
    
    ' 1) Chọn file
    p = Application.GetOpenFilename("Text files,*.txt;*.log,*.*,*.*")
    If p = "False" Then Exit Sub
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    Set ws = GetOrCreate("Data"): ws.Cells.Clear
    Set rxSplit = CreateObject("VBScript.RegExp")
    rxSplit.Global = True
    rxSplit.Pattern = " {3,}"            ' delimiter = cụm ≥3 khoảng trắng
    
    ' 2) Mở file, bỏ toàn bộ dòng TRƯỚC khi gặp CHANNEL=,
    '    rồi gom đủ block CHANNEL=[ ... ] (kể cả xuống dòng)
    f = FreeFile: Open p For Input As #f
    Do Until EOF(f)
        Line Input #f, s
        If InStr(1, s, "CHANNEL=", vbTextCompare) > 0 Then
            header = s
            Do While InStr(1, header, "]") = 0 And Not EOF(f)
                Line Input #f, s
                header = header & " " & s
            Loop
            Exit Do
        End If
    Loop
    
    ' 3) Lấy header giữa [ ... ] → tách phần tử → ghi hàng 1
    If Len(header) > 0 Then
        startPos = InStr(header, "["): endPos = InStrRev(header, "]")
        If startPos > 0 And endPos > startPos Then
            header = Mid$(header, startPos + 1, endPos - startPos - 1)
            header = Replace(header, "&", "")
            header = Replace(header, "'", "")
            header = Replace(header, vbTab, "")
            header = Replace(header, vbCr, "")
            header = Replace(header, vbLf, "")
            hdrItems = Split(header, ",")
            For i = LBound(hdrItems) To UBound(hdrItems)
                If Len(Trim$(hdrItems(i))) > 0 Then ws.Cells(1, i + 1).Value = Trim$(hdrItems(i))
            Next
        End If
    End If
    
    ' 4) Phần còn lại của file = DATA → tách theo ≥3 space,
    '    và xóa mọi space bên trong từng token
    r = 2
    Do Until EOF(f)
        Line Input #f, s
        If Len(Trim$(s)) > 0 Then
            s = Replace(s, vbTab, "   ")   ' nếu có tab, coi ~ delimiter
            s = rxSplit.Replace(s, vbTab)
            parts = Split(s, vbTab)
            c = 0
            For Each t In parts
                t = Replace(t, " ", "")
                If Len(t) > 0 Then
                    c = c + 1
                    ws.Cells(r, c).Value = t
                End If
            Next
            If c > 0 Then r = r + 1
        End If
    Loop
    Close #f
    
    ws.UsedRange.Columns.AutoFit
    
CleanUp:
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub

Private Function GetOrCreate(name$) As Worksheet
    On Error Resume Next: Set GetOrCreate = Sheets(name)
    If GetOrCreate Is Nothing Then Set GetOrCreate = Sheets.Add: GetOrCreate.Name = name
End Function
